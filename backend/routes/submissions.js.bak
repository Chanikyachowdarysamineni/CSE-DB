const express = require('express');
const router = express.Router();
const { authenticateToken, authorizeRoles } = require('../middleware/auth');
const { pool } = require('../models/User');

// Get my submissions (student)
router.get('/my', authenticateToken, async (req, res) => {
  try {
    const studentId = req.user.id;
    const result = await pool.query(
      `SELECT s.*, a.title as assignment_title, a.deadline 
       FROM submissions s 
       JOIN assignments a ON s.assignment_id = a.id 
       WHERE s.student_id = $1 
       ORDER BY s.submitted_at DESC`,
      [studentId]
    );
    res.json(result.rows);
  } catch (error) {
    console.error('Error fetching submissions:', error);
    res.status(500).json({ error: 'Failed to fetch submissions' });
  }
});

// Submit assignment
router.post('/', authenticateToken, authorizeRoles('Student'), async (req, res) => {
  try {
    const { assignment_id, file_name, file_path } = req.body;
    
    // Validate required fields
    if (!assignment_id || !file_name || !file_path) {
      return res.status(400).json({ error: 'Assignment ID, file name, and file path are required' });
    }
    
    const student_id = req.user.id;

    // Get assignment deadline
    const assignmentResult = await pool.query('SELECT deadline FROM assignments WHERE id = $1', [assignment_id]);
    if (assignmentResult.rows.length === 0) {
      return res.status(404).json({ error: 'Assignment not found' });
    }

    const deadline = new Date(assignmentResult.rows[0].deadline);
    const now = new Date();
    const is_late = now > deadline;

    // Check if already submitted
    const existingSubmission = await pool.query(
      'SELECT * FROM submissions WHERE assignment_id = $1 AND student_id = $2',
      [assignment_id, student_id]
    );

    let result;
    if (existingSubmission.rows.length > 0) {
      // Update existing submission (resubmission)
      result = await pool.query(
        `UPDATE submissions 
         SET file_name = $1, file_path = $2, is_late = $3, 
             resubmissions = resubmissions + 1, submitted_at = CURRENT_TIMESTAMP
         WHERE assignment_id = $4 AND student_id = $5 RETURNING *`,
        [file_name, file_path, is_late, assignment_id, student_id]
      );
    } else {
      // Create new submission
      result = await pool.query(
        `INSERT INTO submissions (assignment_id, student_id, file_name, file_path, is_late)
         VALUES ($1, $2, $3, $4, $5) RETURNING *`,
        [assignment_id, student_id, file_name, file_path, is_late]
      );
    }

    res.status(201).json(result.rows[0]);
  } catch (error) {
    console.error('Error submitting assignment:', error);
    res.status(500).json({ error: 'Failed to submit assignment' });
  }
});

// Grade submission
router.put('/:id/grade', authenticateToken, authorizeRoles('HOD', 'DEAN', 'Faculty'), async (req, res) => {
  try {
    const { id } = req.params;
    const { grade, feedback } = req.body;

    const result = await pool.query(
      `UPDATE submissions 
       SET grade = $1, feedback = $2, graded_at = CURRENT_TIMESTAMP
       WHERE id = $3 RETURNING *`,
      [grade, feedback, id]
    );

    if (result.rows.length === 0) {
      return res.status(404).json({ error: 'Submission not found' });
    }

    res.json(result.rows[0]);
  } catch (error) {
    console.error('Error grading submission:', error);
    res.status(500).json({ error: 'Failed to grade submission' });
  }
});

// Delete submission (student can delete before deadline)
router.delete('/:id', authenticateToken, async (req, res) => {
  try {
    const { id } = req.params;
    const userId = req.user.id;

    // Get submission
    const submissionResult = await pool.query(
      'SELECT s.*, a.deadline FROM submissions s JOIN assignments a ON s.assignment_id = a.id WHERE s.id = $1',
      [id]
    );

    if (submissionResult.rows.length === 0) {
      return res.status(404).json({ error: 'Submission not found' });
    }

    const submission = submissionResult.rows[0];

    // Check if user owns the submission
    if (submission.student_id !== userId) {
      return res.status(403).json({ error: 'Not authorized to delete this submission' });
    }

    // Check if past deadline
    const deadline = new Date(submission.deadline);
    const now = new Date();
    if (now > deadline) {
      return res.status(403).json({ error: 'Cannot delete submission after deadline' });
    }

    await pool.query('DELETE FROM submissions WHERE id = $1', [id]);
    res.json({ message: 'Submission deleted successfully' });
  } catch (error) {
    console.error('Error deleting submission:', error);
    res.status(500).json({ error: 'Failed to delete submission' });
  }
});

module.exports = router;
